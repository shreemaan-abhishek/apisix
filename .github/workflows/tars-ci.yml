name: CI Tars

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  pull_request:
    types: [labeled]
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tars:
    if: |
      contains(github.event.pull_request.labels.*.name, 'ci-tars') ||
      contains(github.event.pull_request.labels.*.name, 'ci-gateway-all') ||
      github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - buildjet-2vcpu-ubuntu-2004
        os_name:
          - linux_openresty

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 15
    env:
      SERVER_NAME: ${{ matrix.os_name }}
      OPENRESTY_VERSION: default

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Check out APISIX repo
        run: |
          make init_apisix
          make patch_apisix
          make install

      - name: Install lua-resty-openapi-validate
        run: |
          ./ci/utils/install-lua-resty-openapi-validate.sh workbench

      - name: Linux Install
        working-directory: workbench
        run: |
          sudo ./ci/${{ matrix.os_name }}_runner.sh before_install
          sudo --preserve-env=OPENRESTY_VERSION ./ci/${{ matrix.os_name }}_runner.sh do_install

      # The length of the working directory path for buildjet is too long,
      # which will exceed the operating system's limit for the complete path of apisix config_listen.sock.
      - name: move workbech to /tmp
        run: |
          sudo mv ./workbench /tmp

      - name: Setup Tars MySql
        working-directory: /tmp/workbench
        run: |
          docker run -d -p 3306:3306 -v $PWD/t/tars/conf/tars.sql:/docker-entrypoint-initdb.d/tars.sql -e MYSQL_ROOT_PASSWORD=tars2022 mysql:5.7

      - name: Run test cases
        working-directory: /tmp/workbench
        run: |
          sleep 20
          ./ci/tars-ci.sh run_case
